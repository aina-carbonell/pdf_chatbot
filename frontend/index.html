<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DocuChat â€” Ask your documents</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;1,9..144,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
/* â”€â”€ Reset & Base â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#F7F5F2;
  --surface:#FFFFFF;
  --surface2:#F0EDE8;
  --border:#E0DAD2;
  --ink:#1A1714;
  --ink2:#6B6560;
  --ink3:#9E9892;
  --accent:#2D5A3D;
  --accent-light:#E8F0EA;
  --accent-soft:#4A8B5C;
  --warn:#C0392B;
  --warn-light:#FEF0EE;
  --gold:#9B7E46;
  --radius:12px;
  --radius-sm:8px;
  --shadow:0 1px 3px rgba(0,0,0,.06),0 4px 16px rgba(0,0,0,.04);
  --shadow-lg:0 4px 24px rgba(0,0,0,.1);
  --font-serif:'Fraunces',Georgia,serif;
  --font-sans:'DM Sans',system-ui,sans-serif;
  --sidebar-w:300px;
  --header-h:60px;
}

html,body{height:100%;font-family:var(--font-sans);background:var(--bg);color:var(--ink);font-size:15px;line-height:1.6}

/* â”€â”€ Auth Overlay â”€â”€ */
#auth-overlay{
  position:fixed;inset:0;background:var(--bg);z-index:9999;
  display:flex;align-items:center;justify-content:center;
}
.auth-card{
  background:var(--surface);border:1px solid var(--border);border-radius:20px;
  padding:48px 40px;max-width:420px;width:90%;box-shadow:var(--shadow-lg);
  animation:fadeUp .4s ease;
}
.auth-logo{font-family:var(--font-serif);font-size:28px;font-weight:300;color:var(--accent);margin-bottom:8px;letter-spacing:-.5px}
.auth-logo span{color:var(--ink)}
.auth-subtitle{color:var(--ink2);font-size:14px;margin-bottom:32px}
.auth-tabs{display:flex;border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;margin-bottom:24px}
.auth-tab{flex:1;padding:10px;text-align:center;cursor:pointer;font-size:14px;font-weight:500;color:var(--ink2);background:none;border:none;transition:.2s}
.auth-tab.active{background:var(--accent);color:#fff}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;font-weight:500;color:var(--ink2);margin-bottom:6px;letter-spacing:.3px;text-transform:uppercase}
.form-control{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font-sans);font-size:15px;background:var(--surface);color:var(--ink);outline:none;transition:.2s}
.form-control:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(45,90,61,.1)}
.btn-primary{
  width:100%;padding:13px;background:var(--accent);color:#fff;border:none;border-radius:var(--radius-sm);
  font-family:var(--font-sans);font-size:15px;font-weight:500;cursor:pointer;transition:.2s;
  letter-spacing:.2px;
}
.btn-primary:hover{background:var(--accent-soft)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.auth-error{color:var(--warn);font-size:13px;margin-top:10px;padding:10px 12px;background:var(--warn-light);border-radius:var(--radius-sm)}

/* â”€â”€ App Shell â”€â”€ */
#app{display:flex;height:100vh;overflow:hidden}

/* â”€â”€ Sidebar â”€â”€ */
#sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;transition:.3s;
}
.sidebar-header{
  height:var(--header-h);display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;border-bottom:1px solid var(--border);flex-shrink:0;
}
.logo{font-family:var(--font-serif);font-size:20px;font-weight:400;color:var(--accent);letter-spacing:-.3px}
.logo span{color:var(--ink);font-weight:300}
.btn-icon{background:none;border:none;cursor:pointer;color:var(--ink2);padding:6px;border-radius:var(--radius-sm);transition:.2s;display:flex;align-items:center}
.btn-icon:hover{background:var(--surface2);color:var(--ink)}
.btn-icon svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

/* Documents Panel */
.sidebar-section{padding:16px;border-bottom:1px solid var(--border)}
.sidebar-section-title{
  font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:.8px;color:var(--ink3);
  margin-bottom:12px;
}
.drop-zone{
  border:2px dashed var(--border);border-radius:var(--radius);padding:20px 16px;
  text-align:center;cursor:pointer;transition:.2s;background:var(--bg);
  position:relative;
}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--accent);background:var(--accent-light)}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.drop-zone-icon{margin-bottom:8px;color:var(--ink3)}
.drop-zone-icon svg{width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:1.5}
.drop-zone p{font-size:13px;color:var(--ink2);line-height:1.4}
.drop-zone p strong{color:var(--accent);font-weight:500}

/* Document List */
.doc-list{display:flex;flex-direction:column;gap:6px}
.doc-item{
  display:flex;align-items:center;gap:10px;padding:10px 12px;
  border-radius:var(--radius-sm);background:var(--surface2);border:1px solid transparent;
  animation:fadeIn .3s ease;position:relative;overflow:hidden;
}
.doc-item-icon{flex-shrink:0;width:32px;height:32px;border-radius:6px;
  display:flex;align-items:center;justify-content:center;font-size:16px}
.doc-item-icon.pdf{background:#FEE2E2;color:#DC2626}
.doc-item-icon.docx,.doc-item-icon.doc{background:#DBEAFE;color:#2563EB}
.doc-item-icon.txt,.doc-item-icon.md{background:#FEF3C7;color:#D97706}
.doc-item-body{flex:1;min-width:0}
.doc-item-name{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--ink)}
.doc-item-meta{font-size:11px;color:var(--ink3)}
.doc-item-status{
  font-size:10px;font-weight:500;padding:2px 7px;border-radius:20px;letter-spacing:.3px;
}
.doc-item-status.ready{background:var(--accent-light);color:var(--accent)}
.doc-item-status.processing{background:#FEF3C7;color:#B45309}
.doc-item-status.error{background:var(--warn-light);color:var(--warn)}
.doc-progress{
  position:absolute;bottom:0;left:0;height:2px;background:var(--accent);border-radius:0;
  animation:progressAnim 2s ease-in-out infinite;
}
.btn-delete-doc{
  background:none;border:none;cursor:pointer;color:var(--ink3);padding:3px;border-radius:4px;
  opacity:0;transition:.2s;flex-shrink:0;
}
.btn-delete-doc:hover{background:var(--warn-light);color:var(--warn)}
.doc-item:hover .btn-delete-doc{opacity:1}
.btn-delete-doc svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}

/* Conversations */
.conv-list{flex:1;overflow-y:auto;padding:12px 8px}
.conv-item{
  padding:10px 12px;border-radius:var(--radius-sm);cursor:pointer;
  border:1px solid transparent;transition:.2s;margin-bottom:2px;
}
.conv-item:hover{background:var(--surface2)}
.conv-item.active{background:var(--accent-light);border-color:var(--border)}
.conv-item-title{font-size:13px;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.conv-item-date{font-size:11px;color:var(--ink3);margin-top:2px}
.new-conv-btn{
  margin:8px;padding:10px 14px;background:var(--accent);color:#fff;border:none;border-radius:var(--radius-sm);
  font-family:var(--font-sans);font-size:13px;font-weight:500;cursor:pointer;transition:.2s;
  display:flex;align-items:center;gap:8px;justify-content:center;
}
.new-conv-btn:hover{background:var(--accent-soft)}
.new-conv-btn svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2}

/* Sidebar Footer */
.sidebar-footer{
  border-top:1px solid var(--border);padding:14px 16px;
  display:flex;align-items:center;gap:10px;
}
.user-avatar{
  width:32px;height:32px;border-radius:50%;background:var(--accent);
  color:#fff;display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:600;flex-shrink:0;
}
.user-name{flex:1;font-size:13px;font-weight:500;color:var(--ink)}
.btn-logout{background:none;border:none;cursor:pointer;color:var(--ink3);padding:5px;border-radius:4px;transition:.2s}
.btn-logout:hover{background:var(--surface2);color:var(--warn)}
.btn-logout svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2}

/* â”€â”€ Main Chat Area â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}
.chat-header{
  height:var(--header-h);display:flex;align-items:center;padding:0 24px;gap:12px;
  border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;
}
.chat-header-title{font-family:var(--font-serif);font-size:18px;font-weight:400;flex:1;color:var(--ink);letter-spacing:-.3px}
.chat-header-meta{font-size:12px;color:var(--ink3)}
.btn-menu{display:none}

/* Messages */
#messages{flex:1;overflow-y:auto;padding:32px 24px;display:flex;flex-direction:column;gap:24px}
.msg{display:flex;gap:14px;animation:fadeIn .3s ease}
.msg.user{flex-direction:row-reverse}
.msg-avatar{
  width:32px;height:32px;border-radius:50%;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;
}
.msg.user .msg-avatar{background:var(--accent);color:#fff}
.msg.assistant .msg-avatar{background:var(--gold);color:#fff;font-family:var(--font-serif)}
.msg-body{max-width:720px;flex:1}
.msg.user .msg-body{align-items:flex-end;display:flex;flex-direction:column}
.msg-bubble{
  padding:14px 18px;border-radius:16px;font-size:15px;line-height:1.65;
  word-break:break-word;
}
.msg.user .msg-bubble{
  background:var(--accent);color:#fff;border-bottom-right-radius:4px;
  max-width:480px;
}
.msg.assistant .msg-bubble{
  background:var(--surface);border:1px solid var(--border);border-bottom-left-radius:4px;
  color:var(--ink);box-shadow:var(--shadow);
}
/* Markdown-ish styling inside assistant bubbles */
.msg.assistant .msg-bubble p{margin-bottom:10px}
.msg.assistant .msg-bubble p:last-child{margin-bottom:0}
.msg.assistant .msg-bubble strong{font-weight:600;color:var(--ink)}
.msg.assistant .msg-bubble em{font-style:italic;color:var(--ink2)}
.msg.assistant .msg-bubble ul,.msg.assistant .msg-bubble ol{padding-left:20px;margin:8px 0}
.msg.assistant .msg-bubble li{margin-bottom:4px}
.msg.assistant .msg-bubble h1,.msg.assistant .msg-bubble h2,.msg.assistant .msg-bubble h3{
  font-family:var(--font-serif);font-weight:400;margin:16px 0 8px;color:var(--ink);
}
.msg.assistant .msg-bubble code{
  background:var(--surface2);padding:1px 5px;border-radius:4px;font-size:13px;
}
.msg.assistant .msg-bubble pre{
  background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:14px;overflow-x:auto;margin:10px 0;
}
.msg.assistant .msg-bubble pre code{background:none;padding:0}
.msg-time{font-size:11px;color:var(--ink3);margin-top:6px}
.msg.user .msg-time{text-align:right}

/* Sources */
.msg-sources{margin-top:10px}
.sources-toggle{
  font-size:12px;color:var(--accent);cursor:pointer;border:none;background:none;
  font-family:var(--font-sans);padding:0;display:flex;align-items:center;gap:4px;font-weight:500;
}
.sources-toggle:hover{text-decoration:underline}
.sources-toggle svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2}
.sources-list{
  margin-top:8px;display:flex;flex-direction:column;gap:4px;
}
.source-chip{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);
  font-size:12px;color:var(--ink2);
}
.source-chip svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2;flex-shrink:0}

/* Typing indicator */
.typing-indicator .msg-bubble{display:flex;align-items:center;gap:6px;min-height:48px}
.dot{width:7px;height:7px;border-radius:50%;background:var(--ink3);animation:bounce .9s infinite}
.dot:nth-child(2){animation-delay:.2s}
.dot:nth-child(3){animation-delay:.4s}

/* Empty state */
.empty-state{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:16px;color:var(--ink2);text-align:center;padding:40px;
}
.empty-icon{font-size:56px;opacity:.4}
.empty-title{font-family:var(--font-serif);font-size:26px;font-weight:300;color:var(--ink);letter-spacing:-.5px}
.empty-subtitle{font-size:14px;color:var(--ink2);max-width:380px;line-height:1.6}
.empty-suggestions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px}
.suggestion-chip{
  padding:8px 16px;border:1px solid var(--border);border-radius:20px;
  font-size:13px;cursor:pointer;background:var(--surface);color:var(--ink2);
  transition:.2s;
}
.suggestion-chip:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}

/* Input Area */
.input-area{
  padding:16px 24px 20px;border-top:1px solid var(--border);background:var(--surface);flex-shrink:0;
}
.doc-filter{
  display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;
}
.doc-filter-chip{
  display:inline-flex;align-items:center;gap:5px;padding:3px 10px 3px 8px;
  border-radius:20px;font-size:12px;border:1px solid var(--border);background:var(--surface2);
  color:var(--ink2);cursor:pointer;transition:.2s;
}
.doc-filter-chip input[type=checkbox]{accent-color:var(--accent);cursor:pointer}
.doc-filter-chip:has(input:checked){border-color:var(--accent);background:var(--accent-light);color:var(--accent)}
.input-box{
  display:flex;align-items:flex-end;gap:10px;
  border:1.5px solid var(--border);border-radius:16px;padding:12px 12px 12px 16px;
  background:var(--surface);transition:.2s;
}
.input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px rgba(45,90,61,.08)}
#chat-input{
  flex:1;background:none;border:none;outline:none;font-family:var(--font-sans);font-size:15px;
  color:var(--ink);resize:none;min-height:24px;max-height:140px;line-height:1.5;
}
#chat-input::placeholder{color:var(--ink3)}
.btn-send{
  width:38px;height:38px;border-radius:10px;background:var(--accent);color:#fff;
  border:none;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
}
.btn-send:hover{background:var(--accent-soft)}
.btn-send:disabled{background:var(--ink3);cursor:not-allowed}
.btn-send svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round}
.input-hint{font-size:11px;color:var(--ink3);margin-top:8px;text-align:center}

/* â”€â”€ Responsive â”€â”€ */
@media(max-width:768px){
  :root{--sidebar-w:100vw}
  #sidebar{
    position:fixed;left:0;top:0;bottom:0;z-index:100;
    transform:translateX(-100%);transition:transform .3s;
  }
  #sidebar.open{transform:translateX(0)}
  .btn-menu{display:flex}
  #messages{padding:20px 16px}
  .input-area{padding:12px 16px 16px}
}

/* â”€â”€ Animations â”€â”€ */
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
@keyframes progressAnim{0%{width:20%}50%{width:70%}100%{width:90%}}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}
::-webkit-scrollbar-thumb:hover{background:var(--ink3)}

/* Notification */
.toast{
  position:fixed;bottom:24px;right:24px;padding:12px 18px;border-radius:var(--radius-sm);
  font-size:14px;box-shadow:var(--shadow-lg);animation:fadeIn .3s ease;z-index:9998;
  max-width:360px;
}
.toast.success{background:var(--accent);color:#fff}
.toast.error{background:var(--warn);color:#fff}
.toast.info{background:var(--ink);color:#fff}
</style>
</head>
<body>

<!-- â”€â”€ Auth Overlay â”€â”€ -->
<div id="auth-overlay">
  <div class="auth-card">
    <div class="auth-logo">Docu<span>Chat</span></div>
    <div class="auth-subtitle">Sign in to access your document knowledge base</div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchTab('register')">Register</button>
    </div>
    <div id="auth-form">
      <div class="form-group">
        <label>Username</label>
        <input class="form-control" type="text" id="auth-username" placeholder="your username" autocomplete="username"/>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input class="form-control" type="password" id="auth-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
      </div>
      <div id="auth-error" class="auth-error" style="display:none"></div>
      <button class="btn-primary" id="auth-submit" onclick="submitAuth()">Sign In</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Main App â”€â”€ -->
<div id="app" style="display:none">
  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="sidebar-header">
      <div class="logo">Docu<span>Chat</span></div>
      <button class="btn-icon" onclick="closeSidebar()" title="Close">
        <svg viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
      </button>
    </div>

    <!-- Documents -->
    <div class="sidebar-section">
      <div class="sidebar-section-title">Knowledge Base</div>
      <div class="drop-zone" id="drop-zone">
        <input type="file" id="file-input" multiple accept=".pdf,.docx,.doc,.txt,.md" onchange="handleFileSelect(this.files)"/>
        <div class="drop-zone-icon">
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </div>
        <p><strong>Upload documents</strong><br>PDF, Word, TXT, MD</p>
      </div>
      <div class="doc-list" id="doc-list" style="margin-top:10px"></div>
    </div>

    <!-- Conversations -->
    <button class="new-conv-btn" onclick="newConversation()">
      <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New conversation
    </button>
    <div class="conv-list" id="conv-list"></div>

    <!-- Footer -->
    <div class="sidebar-footer">
      <div class="user-avatar" id="user-avatar">U</div>
      <div class="user-name" id="user-name">User</div>
      <button class="btn-logout" onclick="logout()" title="Sign out">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </button>
    </div>
  </aside>

  <!-- Chat Main -->
  <main id="main">
    <div class="chat-header">
      <button class="btn-icon btn-menu" onclick="openSidebar()">
        <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="chat-header-title" id="chat-title">New conversation</div>
      <div class="chat-header-meta" id="chat-meta"></div>
    </div>

    <div id="messages">
      <!-- Empty state shown when no messages -->
      <div class="empty-state" id="empty-state">
        <div class="empty-icon">ğŸ“š</div>
        <div class="empty-title">Ask your documents</div>
        <div class="empty-subtitle">Upload PDF, Word, or text files â€” then ask questions, request summaries, compare documents, or extract specific information.</div>
        <div class="empty-suggestions" id="suggestions">
          <div class="suggestion-chip" onclick="useSuggestion(this)">Summarize all documents</div>
          <div class="suggestion-chip" onclick="useSuggestion(this)">What are the key points?</div>
          <div class="suggestion-chip" onclick="useSuggestion(this)">Compare the documents</div>
          <div class="suggestion-chip" onclick="useSuggestion(this)">Extract all dates mentioned</div>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="doc-filter" id="doc-filter"></div>
      <div class="input-box">
        <textarea id="chat-input" placeholder="Ask a question about your documentsâ€¦" rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="btn-send" id="send-btn" onclick="sendMessage()" title="Send (Enter)">
          <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
      <div class="input-hint">Press Enter to send Â· Shift+Enter for new line</div>
    </div>
  </main>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = '/api';
let state = {
  user: null,
  authMode: 'login',
  conversations: [],
  currentConvId: null,
  documents: [],
  pollTimers: {},
};

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function switchTab(mode) {
  state.authMode = mode;
  document.querySelectorAll('.auth-tab').forEach((t, i) => {
    t.classList.toggle('active', (i === 0 && mode === 'login') || (i === 1 && mode === 'register'));
  });
  document.getElementById('auth-submit').textContent = mode === 'login' ? 'Sign In' : 'Create Account';
  document.getElementById('auth-error').style.display = 'none';
}

async function submitAuth() {
  const username = document.getElementById('auth-username').value.trim();
  const password = document.getElementById('auth-password').value;
  const errEl = document.getElementById('auth-error');
  const btn = document.getElementById('auth-submit');

  if (!username || !password) { showAuthError('Please fill in all fields.'); return; }
  btn.disabled = true;

  try {
    const endpoint = state.authMode === 'login' ? '/auth/login' : '/auth/register';
    const res = await apiFetch(endpoint, 'POST', { username, password });
    state.user = res;
    initApp();
  } catch (e) {
    showAuthError(e.message || 'Authentication failed. Please try again.');
  } finally {
    btn.disabled = false;
  }
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.style.display = 'block';
}

document.getElementById('auth-password').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitAuth();
});

async function logout() {
  try { await apiFetch('/auth/logout', 'POST'); } catch(e) {}
  state.user = null;
  state.currentConvId = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth-overlay').style.display = 'flex';
  document.getElementById('auth-username').value = '';
  document.getElementById('auth-password').value = '';
}

// â”€â”€ App Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function checkSession() {
  try {
    const res = await apiFetch('/auth/me', 'GET');
    if (res.authenticated) {
      state.user = res;
      initApp();
    }
  } catch(e) {}
}

async function initApp() {
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('app').style.display = 'flex';

  // Set user info
  const name = state.user.username || 'User';
  document.getElementById('user-name').textContent = name;
  document.getElementById('user-avatar').textContent = name[0].toUpperCase();

  await Promise.all([loadDocuments(), loadConversations()]);
  if (!state.currentConvId && state.conversations.length > 0) {
    await loadConversation(state.conversations[0].id);
  } else if (state.conversations.length === 0) {
    await newConversation();
  }
  setupDrop();
}

// â”€â”€ Documents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadDocuments() {
  try {
    const docs = await apiFetch('/documents', 'GET');
    state.documents = docs;
    renderDocList();
    renderDocFilter();
    // Poll processing docs
    docs.filter(d => d.status === 'processing').forEach(d => startPoll(d.id));
  } catch(e) {}
}

function renderDocList() {
  const el = document.getElementById('doc-list');
  if (!state.documents.length) { el.innerHTML = ''; return; }
  el.innerHTML = state.documents.map(doc => `
    <div class="doc-item" id="doc-${doc.id}">
      <div class="doc-item-icon ${doc.file_type}">${fileEmoji(doc.file_type)}</div>
      <div class="doc-item-body">
        <div class="doc-item-name" title="${esc(doc.original_name)}">${esc(doc.original_name)}</div>
        <div class="doc-item-meta">${formatSize(doc.file_size)} Â· ${doc.chunk_count || 0} chunks</div>
      </div>
      <span class="doc-item-status ${doc.status}">${doc.status}</span>
      <button class="btn-delete-doc" onclick="deleteDoc('${doc.id}')" title="Remove">
        <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6 18 20a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
      </button>
      ${doc.status === 'processing' ? '<div class="doc-progress" id="prog-' + doc.id + '"></div>' : ''}
    </div>
  `).join('');
}

function renderDocFilter() {
  const el = document.getElementById('doc-filter');
  const ready = state.documents.filter(d => d.status === 'ready');
  if (ready.length <= 1) { el.innerHTML = ''; return; }
  el.innerHTML = ready.map(doc => `
    <label class="doc-filter-chip">
      <input type="checkbox" value="${doc.id}" checked/>
      ${fileEmoji(doc.file_type)} ${esc(shortName(doc.original_name))}
    </label>
  `).join('');
}

function getSelectedDocIds() {
  const checks = document.querySelectorAll('#doc-filter input[type=checkbox]');
  if (!checks.length) return [];
  return [...checks].filter(c => c.checked).map(c => c.value);
}

async function handleFileSelect(files) {
  for (const file of files) {
    await uploadFile(file);
  }
  document.getElementById('file-input').value = '';
}

async function uploadFile(file) {
  const id = 'tmp-' + Date.now();
  // Optimistic UI
  const tmpDoc = { id, original_name: file.name, file_type: ext(file.name), file_size: file.size, status: 'processing', chunk_count: 0 };
  state.documents.unshift(tmpDoc);
  renderDocList();

  try {
    const form = new FormData();
    form.append('file', file);
    const res = await fetch(`${API}/documents/upload`, { method: 'POST', credentials: 'include', body: form });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Upload failed');
    }
    const data = await res.json();
    // Replace temp with real
    const idx = state.documents.findIndex(d => d.id === id);
    if (idx >= 0) {
      state.documents[idx] = { ...tmpDoc, id: data.document_id, status: 'processing' };
    }
    renderDocList();
    renderDocFilter();
    startPoll(data.document_id);
    showToast(`"${file.name}" uploaded â€” processingâ€¦`, 'info');
  } catch(e) {
    state.documents = state.documents.filter(d => d.id !== id);
    renderDocList();
    showToast(e.message, 'error');
  }
}

function startPoll(docId) {
  if (state.pollTimers[docId]) return;
  let tries = 0;
  state.pollTimers[docId] = setInterval(async () => {
    tries++;
    if (tries > 120) { clearInterval(state.pollTimers[docId]); return; }
    try {
      const s = await apiFetch(`/documents/${docId}/status`, 'GET');
      const doc = state.documents.find(d => d.id === docId);
      if (doc) {
        doc.status = s.status;
        doc.chunk_count = s.chunk_count;
      }
      if (s.status !== 'processing') {
        clearInterval(state.pollTimers[docId]);
        delete state.pollTimers[docId];
        renderDocList();
        renderDocFilter();
        if (s.status === 'ready') showToast('Document ready!', 'success');
        else if (s.status === 'error') showToast('Error processing document.', 'error');
      }
    } catch(e) {}
  }, 2500);
}

async function deleteDoc(docId) {
  if (!confirm('Remove this document from your knowledge base?')) return;
  try {
    await apiFetch(`/documents/${docId}`, 'DELETE');
    state.documents = state.documents.filter(d => d.id !== docId);
    renderDocList();
    renderDocFilter();
    showToast('Document removed.', 'info');
  } catch(e) {
    showToast('Could not remove document.', 'error');
  }
}

// â”€â”€ Conversations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadConversations() {
  try {
    state.conversations = await apiFetch('/conversations', 'GET');
    renderConvList();
  } catch(e) {}
}

function renderConvList() {
  const el = document.getElementById('conv-list');
  if (!state.conversations.length) { el.innerHTML = '<div style="padding:12px 16px;font-size:13px;color:var(--ink3)">No conversations yet</div>'; return; }
  el.innerHTML = state.conversations.map(c => `
    <div class="conv-item ${c.id === state.currentConvId ? 'active' : ''}" onclick="loadConversation('${c.id}')">
      <div class="conv-item-title">${esc(c.title || 'New conversation')}</div>
      <div class="conv-item-date">${formatDate(c.created_at)}</div>
    </div>
  `).join('');
}

async function newConversation() {
  try {
    const res = await apiFetch('/conversations', 'POST');
    state.currentConvId = res.conversation_id;
    await loadConversations();
    renderConvList();
    clearMessages();
    document.getElementById('chat-title').textContent = 'New conversation';
    document.getElementById('chat-meta').textContent = '';
    if (window.innerWidth <= 768) closeSidebar();
  } catch(e) {
    showToast('Could not create conversation.', 'error');
  }
}

async function loadConversation(id) {
  state.currentConvId = id;
  const conv = state.conversations.find(c => c.id === id);
  document.getElementById('chat-title').textContent = conv?.title || 'Conversation';
  document.getElementById('chat-meta').textContent = formatDate(conv?.created_at);
  renderConvList();
  clearMessages();

  try {
    const msgs = await apiFetch(`/conversations/${id}/messages`, 'GET');
    msgs.forEach(m => appendMessage(m.role, m.content, m.sources, false));
    scrollToBottom();
  } catch(e) {}
  if (window.innerWidth <= 768) closeSidebar();
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function clearMessages() {
  const el = document.getElementById('messages');
  el.innerHTML = `
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">ğŸ“š</div>
      <div class="empty-title">Ask your documents</div>
      <div class="empty-subtitle">Upload PDF, Word, or text files â€” then ask questions, request summaries, compare documents, or extract specific information.</div>
      <div class="empty-suggestions" id="suggestions">
        <div class="suggestion-chip" onclick="useSuggestion(this)">Summarize all documents</div>
        <div class="suggestion-chip" onclick="useSuggestion(this)">What are the key points?</div>
        <div class="suggestion-chip" onclick="useSuggestion(this)">Compare the documents</div>
        <div class="suggestion-chip" onclick="useSuggestion(this)">Extract all dates mentioned</div>
      </div>
    </div>`;
}

function useSuggestion(el) {
  document.getElementById('chat-input').value = el.textContent;
  sendMessage();
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const question = input.value.trim();
  if (!question || !state.currentConvId) return;

  const readyDocs = state.documents.filter(d => d.status === 'ready');
  if (!readyDocs.length) {
    showToast('Please upload and process documents first.', 'info');
    return;
  }

  input.value = '';
  autoResize(input);
  hideEmptyState();

  appendMessage('user', question, [], true);
  const typingId = appendTyping();

  const btn = document.getElementById('send-btn');
  btn.disabled = true;

  try {
    const docIds = getSelectedDocIds();
    const res = await apiFetch(`/conversations/${state.currentConvId}/chat`, 'POST', {
      question,
      document_ids: docIds
    });
    removeTyping(typingId);
    appendMessage('assistant', res.answer, res.sources || [], true);

    // Update conversation title
    const conv = state.conversations.find(c => c.id === state.currentConvId);
    if (conv && (conv.title === 'New conversation' || !conv.title)) {
      conv.title = question.substring(0, 55) + (question.length > 55 ? 'â€¦' : '');
      document.getElementById('chat-title').textContent = conv.title;
      renderConvList();
    }
  } catch(e) {
    removeTyping(typingId);
    appendMessage('assistant', `âš ï¸ Error: ${e.message}. Please check your backend configuration.`, [], true);
  } finally {
    btn.disabled = false;
    input.focus();
  }
}

function appendMessage(role, content, sources, animate) {
  hideEmptyState();
  const el = document.getElementById('messages');
  const id = 'msg-' + Date.now() + Math.random();
  const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  const sourcesHtml = sources && sources.length ? `
    <div class="msg-sources">
      <button class="sources-toggle" onclick="toggleSources('${id}')">
        <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        ${sources.length} source${sources.length > 1 ? 's' : ''}
      </button>
      <div class="sources-list" id="src-${id}" style="display:none">
        ${sources.map(s => `
          <div class="source-chip">
            <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
            ${esc(s.document)}${s.page ? ` â€” p.${s.page}` : ''}
          </div>
        `).join('')}
      </div>
    </div>` : '';

  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.id = id;
  div.innerHTML = `
    <div class="msg-avatar">${role === 'user' ? (state.user?.username?.[0]?.toUpperCase() || 'U') : 'D'}</div>
    <div class="msg-body">
      <div class="msg-bubble">${role === 'assistant' ? renderMarkdown(content) : esc(content)}</div>
      ${sourcesHtml}
      <div class="msg-time">${time}</div>
    </div>`;

  if (!animate) div.style.animation = 'none';
  el.appendChild(div);
  scrollToBottom();
  return id;
}

function toggleSources(id) {
  const src = document.getElementById(`src-${id}`);
  src.style.display = src.style.display === 'none' ? 'flex' : 'none';
  src.style.flexDirection = 'column';
}

function appendTyping() {
  const el = document.getElementById('messages');
  hideEmptyState();
  const id = 'typing-' + Date.now();
  const div = document.createElement('div');
  div.className = 'msg assistant typing-indicator';
  div.id = id;
  div.innerHTML = `
    <div class="msg-avatar">D</div>
    <div class="msg-body">
      <div class="msg-bubble">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </div>`;
  el.appendChild(div);
  scrollToBottom();
  return id;
}

function removeTyping(id) {
  document.getElementById(id)?.remove();
}

function hideEmptyState() {
  const el = document.getElementById('empty-state');
  if (el) el.remove();
}

// â”€â”€ Input Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 140) + 'px';
}

// â”€â”€ Drag & Drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function setupDrop() {
  const zone = document.getElementById('drop-zone');
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    handleFileSelect(e.dataTransfer.files);
  });
}

// â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openSidebar() { document.getElementById('sidebar').classList.add('open'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }

// â”€â”€ Markdown Renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderMarkdown(text) {
  // Very simple markdown: bold, italic, code, headings, lists
  return text
    .split('\n').map(line => {
      line = esc(line);
      line = line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      line = line.replace(/\*(.+?)\*/g, '<em>$1</em>');
      line = line.replace(/`(.+?)`/g, '<code>$1</code>');
      line = line.replace(/^###\s+(.+)/, '<h3>$1</h3>');
      line = line.replace(/^##\s+(.+)/, '<h2>$1</h2>');
      line = line.replace(/^#\s+(.+)/, '<h1>$1</h1>');
      line = line.replace(/^\* (.+)/, '<li>$1</li>');
      line = line.replace(/^\d+\. (.+)/, '<li>$1</li>');
      return line;
    })
    .join('\n')
    .replace(/\n{2,}/g, '</p><p>')
    .replace(/^(.+)$/, '<p>$1</p>');
}

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function esc(s) {
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function ext(name) { return (name || '').split('.').pop().toLowerCase(); }
function shortName(name) { return name.length > 18 ? name.substring(0,16) + 'â€¦' : name; }
function formatSize(b) {
  if (!b) return '';
  if (b < 1024) return b + ' B';
  if (b < 1024*1024) return (b/1024).toFixed(0) + ' KB';
  return (b/1024/1024).toFixed(1) + ' MB';
}
function formatDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
}
function fileEmoji(type) {
  const map = { pdf: 'ğŸ“„', docx: 'ğŸ“', doc: 'ğŸ“', txt: 'ğŸ“ƒ', md: 'ğŸ“‹' };
  return map[type] || 'ğŸ“„';
}
function scrollToBottom() {
  const el = document.getElementById('messages');
  el.scrollTop = el.scrollHeight;
}

function showToast(msg, type='info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

async function apiFetch(path, method, body) {
  const opts = { method, credentials: 'include', headers: {} };
  if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
  const res = await fetch(API + path, opts);
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkSession();
</script>
</body>
</html>